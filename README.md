# Stokes 偏振光分析系统

基于 Python 的偏振光图像分析工具，用于计算 Stokes 参数并在庞加莱球上可视化偏振态。

## 项目简介

本项目是一个光电信息创新设计课程的作品，实现了从偏振图像中提取 Stokes 参数（S0, S1, S2, S3）并进行偏振态分析的完整流程。系统支持多种采样工具，可以对偏振图像进行交互式分析，并通过三维庞加莱球直观展示偏振态的演化。

### 主要功能

- 📸 **多图像处理**：同时处理 4 张不同偏振角度的图像
- 🎯 **智能原点标定**：首次运行标定原点，后续自动加载
- 🖊️ **多种采样工具**：
  - 直线工具：沿直线均匀采样
  - 椭圆工具：沿椭圆轨迹采样
  - 描点工具：自由绘制采样路径
- 📊 **Stokes 参数计算**：自动计算 S0~S3 及归一化参数
- 🔍 **偏振态识别**：自动判断线偏光、圆偏光、椭圆偏光
- 🌐 **3D 可视化**：使用 PyVista 绘制交互式庞加莱球
- 📈 **多图预览**：同时显示所有图像的采样点位置

## 环境要求

- Python 3.8+
- Windows/Linux/macOS

### 依赖库

```
numpy >= 2.0
pandas >= 2.0
matplotlib >= 3.9
Pillow >= 9.0
pyvista >= 0.45
```

## 安装步骤

1. 克隆或下载本项目

2. 创建虚拟环境（推荐）
```bash
python -m venv .venv
```

3. 激活虚拟环境
```bash
# Windows (Cygwin/Git Bash)
source .venv/Scripts/activate

# Linux/macOS
source .venv/bin/activate
```

4. 安装依赖
```bash
pip install numpy pandas matplotlib pillow pyvista
```

## 使用说明

### 1. stokes_pro.py（推荐使用）

**功能**：高级版本，提供交互式 GUI 采样工具

**运行方式**：
```bash
python stokes_pro.py
```

**使用流程**：

#### 步骤 1：准备输入文件

需要准备以下文件：

1. **4 张偏振图像**，文件名必须以以下后缀结尾：
   - `*00.png/jpg` - 0° 偏振片，0° 检偏器
   - `*090.png/jpg` - 0° 偏振片，90° 检偏器
   - `*045.png/jpg` - 0° 偏振片，45° 检偏器
   - `*9045.png/jpg` - 90° 偏振片，45° 检偏器

2. **max_i.txt** - 最大光强值文件
   - 默认路径：`C:\Users\joengzaang\Desktop\课设\max_i.txt`
   - 格式：
     ```
     文件名(不含扩展名)    最大光强值
     image00              255.0
     image090             255.0
     image045             255.0
     image9045            255.0
     ```
   - 如需修改路径，请编辑 `stokes_pro.py` 第 37 行

#### 步骤 2：选择图像文件

运行程序后，会弹出文件选择对话框，选择 4 张偏振图像。

#### 步骤 3：标定原点（仅首次运行）

- 首次运行时，程序会依次显示每张图像
- 在每张图像上点击相同的物理位置作为原点 (0,0)
- 原点坐标会保存到 `locations.txt`，后续运行自动加载
- 如需重新标定，删除 `locations.txt` 即可

#### 步骤 4：选择采样工具

程序会显示第一张图像和三个工具按钮：

**🔹 直线工具**
- 点击两个点定义一条直线
- 程序会沿直线均匀采样（每 10 像素一个点）
- 右键可撤销上一个点

**🔹 椭圆工具**
- 点击两个对角点定义椭圆的外接矩形
- 程序会沿椭圆周长均匀采样
- 右键可撤销

**🔹 描点工具**
- 自由点击绘制采样路径
- 程序会在相邻点之间插值采样
- 右键撤销上一个点
- 按 **Enter** 键完成采样

#### 步骤 5：查看结果

采样完成后，程序会：

1. **显示多图预览窗口**
   - 2×2 布局显示 4 张图像
   - 红色点和连线标注采样位置
   - 蓝色数字标注点序号

2. **打开 3D 庞加莱球**
   - 红色点表示各采样点的偏振态
   - 红色连线显示偏振态演化路径
   - 灰色箭头指示演化方向
   - 左下角复选框可切换数据表显示
   - 支持鼠标旋转、缩放交互

3. **生成输出文件**
   - `grayscale_stokes_output.txt` - 包含所有计算结果的表格

### 2. stokes.py（基础版本）

**功能**：手动点选固定数量的采样点

**运行方式**：
```bash
python stokes.py
```

**使用流程**：
- 与 stokes_pro.py 类似，但采样方式为手动点击固定数量的点（默认 5 个）
- 修改第 15 行 `n = 5` 可调整采样点数量

### 3. grayscale_analysis.py

**功能**：分析图像中选定区域的平均灰度值

**运行方式**：
```bash
python grayscale_analysis.py
```

**使用流程**：
1. 选择一张或多张图像
2. 在第一张图像上拖动鼠标框选矩形区域
3. 程序会计算该区域在所有图像中的平均灰度值
4. 结果保存到 `grayscale_results.txt`
5. 同时生成灰度图像（文件名添加 `_gray` 后缀）

### 4. polarization_analysis.py

**功能**：简单的 Stokes 参数计算器

**运行方式**：
```bash
python polarization_analysis.py
```

**说明**：
- 使用硬编码的光强值进行计算
- 适合快速验证 Stokes 公式
- 修改第 4-7 行的光强值即可计算不同情况

## 输出文件说明

### grayscale_stokes_output.txt

制表符分隔的文本文件，包含以下列：

| 列名 | 说明 |
|------|------|
| Index | 采样点序号 |
| Coordinate | 相对坐标 (x, y) |
| gray(0,0) | 0°-0° 图像的灰度值 × 最大光强 |
| gray(0,90) | 0°-90° 图像的灰度值 × 最大光强 |
| gray(0,45) | 0°-45° 图像的灰度值 × 最大光强 |
| gray(90,45) | 90°-45° 图像的灰度值 × 最大光强 |
| S0 | Stokes 参数 S0 = gray(0,0) + gray(0,90) |
| S1 | Stokes 参数 S1 = gray(0,0) - gray(0,90) |
| S2 | Stokes 参数 S2 = 2×gray(0,45) - S0 |
| S3 | Stokes 参数 S3 = S0 - 2×gray(90,45) |
| S0* | 归一化 S0 = 1.00 |
| S1* | 归一化 S1 = S1/S0 |
| S2* | 归一化 S2 = S2/S0 |
| S3* | 归一化 S3 = S3/S0 |
| p | 偏振度 = √(S1*² + S2*² + S3*²) |
| State | 偏振态（角度 + 类型） |

**偏振态分类**：
- **线偏光**：-0.1 < S3* ≤ 0.1
- **右旋椭圆偏光**：0.1 < S3* ≤ 0.9
- **右旋圆偏光**：0.9 < S3* < 1.1
- **左旋椭圆偏光**：-0.9 < S3* ≤ -0.1
- **左旋圆偏光**：-1.1 < S3* ≤ -0.9

### locations.txt

缓存文件，存储每张图像的原点坐标：
```
image00.png 1024 768
image090.png 1024 768
image045.png 1024 768
image9045.png 1024 768
```

## 技术细节

### Stokes 参数计算公式

```
S0 = I(0°,0°) + I(0°,90°)
S1 = I(0°,0°) - I(0°,90°)
S2 = 2×I(0°,45°) - S0
S3 = S0 - 2×I(90°,45°)
```

其中 I(α,β) 表示偏振片角度为 α、检偏器角度为 β 时的光强。

### 偏振度计算

```
p = √(S1² + S2² + S3²) / S0
```

对于完全偏振光，p = 1；对于自然光，p = 0。

### 庞加莱球坐标

庞加莱球上的点坐标为 (S1*, S2*, S3*)，其中：
- S1* 轴：水平/垂直线偏光
- S2* 轴：±45° 线偏光
- S3* 轴：左旋/右旋圆偏光

球面上任意点代表一种偏振态，球心到该点的距离表示偏振度。

## 常见问题

### Q1: 提示找不到 max_i.txt 文件

**解决方法**：
- 检查文件路径是否正确（默认：`C:\Users\joengzaang\Desktop\课设\max_i.txt`）
- 修改 `stokes_pro.py` 第 37 行的路径
- 或在该路径创建 max_i.txt 文件

### Q2: 图像文件名不符合要求

**解决方法**：
- 确保文件名以 `00`、`090`、`045` 或 `9045` 结尾
- 例如：`sample00.png`、`test_090.jpg` 都是有效的

### Q3: 原点标定错误，想重新标定

**解决方法**：
- 删除图像所在目录下的 `locations.txt` 文件
- 重新运行程序即可重新标定

### Q4: PyVista 窗口无法显示

**解决方法**：
- 确保安装了 PyVista：`pip install pyvista`
- 检查显卡驱动是否支持 OpenGL
- 尝试更新显卡驱动

### Q5: matplotlib 窗口无法交互

**解决方法**：
- 程序使用 Qt5Agg 后端，确保安装了 PyQt5：`pip install PyQt5`
- 如果仍有问题，可修改第 15 行为 `matplotlib.use('TkAgg')`

## 项目结构

```
course_design/
├── stokes_pro.py              # 主程序（高级版）
├── stokes.py                  # 主程序（基础版）
├── grayscale_analysis.py      # 灰度分析工具
├── polarization_analysis.py   # Stokes 计算器
├── confirm.py                 # 数据验证脚本
├── README.md                  # 本文件
├── CLAUDE.md                  # AI 辅助开发文档
└── .venv/                     # 虚拟环境（可选）
```

## 开发团队

**光电信息创新设计 第 8 组**
- Yhx, Cjt, Yz, Hyx, Lym, Dzh
- 2025年7月

## 许可证

本项目仅供学习和研究使用。

## 更新日志

- **2025-07-12**: 完成 stokes_pro.py 高级版本
- **2025-07-08**: 初始版本发布

